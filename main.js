(()=>{"use strict";class e{static createDateElement(t){const s=document.createElement("div");return s.classList.add("post-date"),s.textContent=void 0!==t?t:e.getCurrentDateTime(),s}static createDownloadElement(){const e=document.createElement("div");return e.classList.add("download-file"),e.classList.add("icon"),e}static createImageElement(e,t){const s=document.createElement("img");return s.classList.add("image"),s.classList.add("media"),s.src=e,s.textContent=t,s.dataset.name=t,s}static createVideoElement(e,t){const s=document.createElement("video");return s.classList.add("video"),s.classList.add("media"),s.src=e,s.controls="controls",s.textContent=t,s.dataset.name=t,s}static createAudioElement(e,t){const s=document.createElement("audio");return s.classList.add("media"),s.src=e,s.controls="controls",s.textContent=t,s.dataset.name=t,s}static createTextElement(t){const s=document.createElement("div");return s.classList.add("post-text"),s.innerHTML=e.makeClickableLinks(t.replace(/\n/g,"<br />")),s}static createPostElement(t){const s=document.createElement("div");s.classList.add("post"),s.append(this.createDateElement(t.dateString));let n=null;return t.type.match(/image/)?(n=e.createImageElement(t.file,t.name),s.append(e.createDownloadElement())):t.type.match(/video/)?(n=e.createVideoElement(t.file,t.name),s.append(e.createDownloadElement())):t.type.match(/audio/)?(n=e.createAudioElement(t.file,t.name),s.append(e.createDownloadElement())):n=e.createTextElement(t.message),s.append(n),s}static getCurrentDateTime(){const e=new Date;return`${e.toLocaleDateString()} ${e.toLocaleTimeString().slice(0,-3)}`}static makeClickableLinks(e){return e.replace(/(https?:\/\/[^\s]+)/g,"<a href='$1'>$1</a>")}}class t{constructor(){this.element=document.querySelector(".chaos"),this.emoji=["💜","💙","💖","😂","😁","😃","😄","🤣","😅","😆","😇","😉","😊","🙂","🙃","😋","😌","😍","🥰","😘","😗","😚","😜","😝","😛","🤑","😶","👍","👎","🔥"],this.emojiBtn=document.querySelector(".chaos-control__create-post-emoji")}showList(){if(this.element.querySelector(".emoji-list")){const e=this.element.querySelector(".emoji-list");return void this.element.removeChild(e)}this.first=!0;const e=document.createElement("div");e.classList.add("emoji-list"),this.emoji.forEach((t=>{e.innerHTML+=`<span class="emoji">${t}</span>`})),this.element.appendChild(e);const t=this.emojiBtn.getBoundingClientRect(),s=e.getBoundingClientRect(),n=t.top-s.height-3,o=t.left-s.width/2+t.width/2;e.style.top=`${n}px`,e.style.left=`${o}px`,e.addEventListener("click",this.addEmoji)}addEmoji(e){if(!e.target.closest(".emoji"))return;this.textArea=document.querySelector(".chaos-control__create-post-text");const t=e.target.closest(".emoji").textContent;this.textArea.value+=` ${t} `}close(e){if(e.target.closest(".emoji-list"))return;const t=this.element.querySelector(".emoji-list");t&&(e.target.closest(".chaos-control__create-post-emoji")&&!0===this.first?this.first=!1:(this.element.removeChild(t),this.element.removeEventListener("click",this.emoji.close),t.removeEventListener("click",this.emoji.addEmoji)))}}class s{constructor(){this.chaosContent=document.querySelector(".chaos-content"),this.fileInput=document.querySelector(".file-input"),this.addFileButton=document.querySelector(".chaos-control__create-post-add"),this.addGeolocationButton=document.querySelector(".chaos-control__create-post-geo"),this.addEmojiButton=document.querySelector(".chaos-control__create-post-emoji"),this.dragArea=document.querySelector(".drag__area"),this.dragEventListener=this.dragEventListener.bind(this),this.lastLoadedPostId=null,this.isStartLoad=!0,this.isOnlineMode=!0,this.geolocation=null,this.ws=new WebSocket("wss://ahj22-diploma-backend.herokuapp.com")}init(){this.addListeners()}addListeners(){this.addSendButtonListener(),this.addFileAddButtonListener(),this.addGeolocationButtonListener(),this.addEmojiButtonListener(),this.addDragoverEventListener(),this.addDropEventListener(),this.addScrollEventListener(),this.addWSOpenEventListener(),this.addWSMessageEventListener(),this.addWSErrorEventListener()}addScrollEventListener(){this.chaosContent.addEventListener("scroll",this.scrollEventListener.bind(this))}addWSOpenEventListener(){this.ws.addEventListener("open",(()=>{this.getAllPosts()}))}addWSMessageEventListener(){this.ws.addEventListener("message",(e=>{this.restoreAllPosts(e.data)}))}addWSErrorEventListener(){this.ws.addEventListener("error",(()=>{this.isOnlineMode=!1}))}addDragoverEventListener(){document.addEventListener("dragover",this.dragEventListener)}addDropEventListener(){this.dragArea.addEventListener("drop",this.dragEventListener)}static downloadEventListener(e){const t=e.target.closest(".post").querySelector(".media"),s=document.createElement("a");s.href=t.src||t.href,s.download=t.dataset.name,s.click()}scrollEventListener(){this.getAdditionalPosts()}dragEventListener(e){const{type:t}=e;e.preventDefault();const s=this.dragArea.parentElement;if("dragover"===t)return s.classList.remove("hidden"),void s.addEventListener("dragleave",this.drag);if("dragleave"===t)return s.removeEventListener("dragleave",this.drag),void s.classList.add("hidden");if("drop"===t){s.removeEventListener("dragleave",this.drag),s.classList.add("hidden");const t=e.dataTransfer.files[0];this.addFileElement(t),this.sendFilePost(t)}}addFileAddButtonListener(){this.addFileButton.addEventListener("click",(e=>{e.preventDefault(),this.fileInput.dispatchEvent(new MouseEvent("click")),this.fileInput.addEventListener("change",(e=>{const{target:t}=e,s=t.files.item(0);this.addFileElement(s),this.sendFilePost(s)}))}))}geolocationButtonListener(e){e.preventDefault();const t=document.querySelector(".chaos-control__create-post-text");navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{this.geolocation=`Latitude: ${e.coords.latitude.toFixed(4)}, Longitude: ${e.coords.longitude.toFixed(4)}`,t.value+=this.geolocation}),(e=>{alert(`Невозможно определить местоположение! Причина: ${e.message}`)})):alert("Невозможно определить местоположение!")}addGeolocationButtonListener(){this.addGeolocationButton.addEventListener("click",this.geolocationButtonListener.bind(this))}addEmojiButtonListener(){this.addEmojiButton.addEventListener("click",(e=>{e.preventDefault();(new t).showList()}))}addFileElement(t){const n=e.createPostElement({type:t.type,dateString:e.getCurrentDateTime(),file:URL.createObjectURL(t),name:t.name});n.querySelector(".download-file").addEventListener("click",s.downloadEventListener),this.chaosContent.append(n),this.chaosContent.scrollTop=this.chaosContent.scrollHeight}addSendButtonListener(){const t=document.querySelector(".chaos-control__create-post-text"),s=document.querySelector(".chaos-control__send-message");s.addEventListener("click",(s=>{s.preventDefault();const n=t.value;if(n){const s=e.getCurrentDateTime();this.chaosContent.append(e.createPostElement({type:"text",dateString:s,message:n})),this.chaosContent.scrollTop=this.chaosContent.scrollHeight,t.value="",this.sendTextPost(n,s)}})),t.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(s.click(),e.preventDefault())}))}sendTextPost(e,t){this.ws.send(JSON.stringify({event:"addPost",post:{type:"text",dateString:t,message:e}}))}getAllPosts(){const e=JSON.stringify({event:"getAllPosts",count:10,lastId:this.lastLoadedPostId});this.ws.send(e)}getAdditionalPosts(){this.chaosContent.firstChild.getBoundingClientRect().top>=0&&this.getAllPosts()}restoreAllPosts(t){const n=JSON.parse(t),o=n.allPosts;if(n.event.match("botResponse"))return this.chaosContent.append(e.createPostElement(o[0])),void(this.chaosContent.scrollTop=this.chaosContent.scrollHeight);this.lastLoadedPostId=o[0].id;for(const t of o.reverse())try{const n=e.createPostElement(t);this.chaosContent.prepend(n);const o=n.querySelector(".download-file");null!==o&&o.addEventListener("click",s.downloadEventListener)}catch(e){}this.isStartLoad&&(this.isStartLoad=!1,this.chaosContent.scrollTop=this.chaosContent.scrollHeight)}sendFilePost(t){if(!t)return;let s=null;const n=t.type,o=new FileReader;o.readAsDataURL(t),o.onload=()=>{s=o.result;const i=JSON.stringify({event:"addFilePost",post:{dateString:e.getCurrentDateTime(),file:s,type:n,name:t.name}});this.ws.send(i)}}}document.addEventListener("DOMContentLoaded",(()=>{(new s).init()}))})();